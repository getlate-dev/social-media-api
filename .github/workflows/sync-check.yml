name: Ayrshare SDK Sync Check

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9am UTC

  workflow_dispatch:

jobs:
  check:
    name: Check for new Ayrshare methods
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install Ayrshare SDK
        run: npm install social-media-api --no-save

      - name: Extract and compare methods
        id: compare
        run: |
          cat > compare.mjs << 'SCRIPT'
          import { readFileSync, appendFileSync } from 'fs';

          // Extract public methods from Ayrshare SDK by instantiating the class
          const AyrshareSDK = (await import('social-media-api')).default;
          const instance = new AyrshareSDK('dummy_key');
          const proto = Object.getPrototypeOf(instance);
          const ayrshareInternal = new Set(['constructor']);
          const ayrshireMethods = new Set();
          for (const name of Object.getOwnPropertyNames(proto)) {
            if (!ayrshareInternal.has(name) && typeof proto[name] === 'function' && !name.startsWith('_')) {
              ayrshireMethods.add(name);
            }
          }

          // Extract public async methods from our SDK
          const ourSource = readFileSync('src/index.ts', 'utf-8');
          const ourInternal = new Set(['request']);
          const ourMethods = new Set();
          for (const match of ourSource.matchAll(/^\s+async\s+(\w+)\s*\(/gm)) {
            if (!ourInternal.has(match[1])) {
              ourMethods.add(match[1]);
            }
          }
          // Also add non-async public methods
          for (const match of ourSource.matchAll(/^\s+(\w+)\s*\([^)]*\)\s*(?::\s*\w+)?\s*\{/gm)) {
            if (!ourInternal.has(match[1]) && match[1] !== 'constructor') {
              ourMethods.add(match[1]);
            }
          }

          const missing = [...ayrshireMethods].filter(m => !ourMethods.has(m)).sort();
          const removed = [...ourMethods].filter(m => !ayrshireMethods.has(m) && m !== 'setProfileKey').sort();

          console.log(`Ayrshare SDK methods (${ayrshireMethods.size}): ${[...ayrshireMethods].sort().join(', ')}`);
          console.log(`Our SDK methods (${ourMethods.size}): ${[...ourMethods].sort().join(', ')}`);
          console.log(`Missing from our SDK: ${missing.length > 0 ? missing.join(', ') : 'none'}`);
          console.log(`Removed from Ayrshare: ${removed.length > 0 ? removed.join(', ') : 'none'}`);

          const outputFile = process.env.GITHUB_OUTPUT;
          if (outputFile) {
            const lines = [
              `missing=${missing.join(', ')}`,
              `removed=${removed.join(', ')}`,
              `has_changes=${missing.length > 0 || removed.length > 0}`,
              `missing_count=${missing.length}`,
              `removed_count=${removed.length}`,
            ];
            appendFileSync(outputFile, lines.join('\n') + '\n');
          }
          SCRIPT
          node compare.mjs

      - name: Create issue if out of sync
        if: steps.compare.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MISSING="${{ steps.compare.outputs.missing }}"
          REMOVED="${{ steps.compare.outputs.removed }}"
          MISSING_COUNT="${{ steps.compare.outputs.missing_count }}"
          REMOVED_COUNT="${{ steps.compare.outputs.removed_count }}"

          BODY="The weekly sync check found differences between the Ayrshare SDK and our implementation.\n\n"

          if [ "$MISSING_COUNT" -gt 0 ]; then
            BODY+="### New methods in Ayrshare SDK ($MISSING_COUNT)\n\n"
            BODY+="These methods exist in Ayrshare's SDK but not in ours:\n\n"
            IFS=', ' read -ra METHODS <<< "$MISSING"
            for method in "${METHODS[@]}"; do
              BODY+="- \`$method\`\n"
            done
            BODY+="\nThese need to be added to our SDK and backend routes (as implemented or 501 stubs).\n\n"
          fi

          if [ "$REMOVED_COUNT" -gt 0 ]; then
            BODY+="### Removed from Ayrshare SDK ($REMOVED_COUNT)\n\n"
            BODY+="These methods were in Ayrshare's SDK but appear to have been removed:\n\n"
            IFS=', ' read -ra METHODS <<< "$REMOVED"
            for method in "${METHODS[@]}"; do
              BODY+="- \`$method\`\n"
            done
            BODY+="\nConsider deprecating these in our SDK.\n"
          fi

          # Check if an open issue already exists
          EXISTING=$(gh issue list --label "sdk-sync" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING" ]; then
            gh issue comment "$EXISTING" --body "$(echo -e "$BODY")"
            echo "Updated existing issue #$EXISTING"
          else
            gh issue create \
              --title "SDK sync: Ayrshare has new/changed methods" \
              --body "$(echo -e "$BODY")" \
              --label "sdk-sync"
          fi
